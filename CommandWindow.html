<html>
<head>

    <meta charset="utf-8"/>
    <title>Demo</title>
<style type="text/css">

#commandwindowcontainer
{
	height: 200px;
	width: 600px;
	background:#f00;
	overflow: auto;
}

#commandwindow
{
	//position: aboslute;
	top: 0px;
	left: 0px;

	height: 200px;
	width: 600px;

	background-color: #4FC4AF;

	display: table-cell;
    vertical-align: bottom;
	//overflow: scroll;
}

#currentdirectory{
	top: 600px;
	left: 0px;
	width: 600px;
	height: 20px;
	background-color: #F26161;
}



#commandline{
    resize: none;
	width: 600px;
	height: 60px;
	background-color: #95B4DB;
	white-space: nowrap;
	overflow: auto;
}

</style>

<script src="/socket.io/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js"></script>

<script>

$(document).ready(function(){
	var RootReplaceKey = "C:\\AANode\\pictures"

	var rooms = 9
	//var CurrentDirectory = "root:\>"
	var CurrentDirectory = "C:\\AANode\\pictures"
	var CurrentUser = "Unknown"
	socket = io.connect();
	socket.emit("CommandWindowCreated")
	socket.emit("GetDirectoryStructure")

	cmdwnd = document.getElementById("commandwindow");
	var commandwindowdirectorydiv = document.getElementById("currentdirectory");
	commandwindowdirectorydiv.innerHTML = "root"

	document.addEventListener("keydown", function(e)
	{
		//console.log(e.keyCode + "<-- this is the keycode")
		switch(e.keyCode)
		{
			case 13:
			if(e.shiftKey){
				console.log("This is shift enter, it will go to the next line instead of submitting the shit")

			}
			else{
				e.preventDefault()
				console.log("This should send the mail, this will send to all the people i guess?")

				var cmdline = document.getElementById("commandline");
				if(cmdline.value != ""){
					var SwitchedCommandLineInput = cmdline.value.split(" ")
					switch(SwitchedCommandLineInput[0]){
						case "dir":
							var FilesAndDirsCurrentDirectory = LocalDirectoryStructureObject[CurrentDirectory]
							console.log(FilesAndDirsCurrentDirectory + "<-- this is the directory files and dirts after selecting object")
							console.log("Is this the split htat is faliing?")
							SplitFilesDirs = FilesAndDirsCurrentDirectory.split(";")
							console.log(SplitFilesDirs)

							var HTMLText = ""
							if(SplitFilesDirs[0].length > 1){
								var DirText = ""
								SplitDirs = SplitFilesDirs[0].split(",")
								for(var i = 0; i<SplitDirs.length; ++i){
									DirText = DirText + "Dir\>\t" + SplitDirs[i] + "<br/>"
								}
								HTMLText = HTMLText + DirText
							}

							if(SplitFilesDirs[1].length > 1){
								var FileText = ""
								SplitFiles = SplitFilesDirs[1].split(",")
								for(var i = 0; i<SplitFiles.length; ++i){
									FileText = FileText + "File\t" + SplitFiles[i] + "<br/>"
								}
								HTMLText = HTMLText + FileText
							}


							cmdwnd.innerHTML = cmdwnd.innerHTML + "<br>" + HTMLText
							ScrollToEndOfChatBox()
							break
						case "cd":
							var DirectoryKeysArray = Object.keys(LocalDirectoryStructureObject)
							for(var i=0; i<DirectoryKeysArray.length; ++i){
								if(DirectoryKeysArray[i].toLowerCase() == (CurrentDirectory + "\\" + SwitchedCommandLineInput[1]).toLowerCase()){
									CurrentDirectory = DirectoryKeysArray[i]
									commandwindowdirectorydiv.innerHTML = CurrentDirectory.replace(RootReplaceKey, "root")
									break;
								}
							}
							console.log(CurrentDirectory + "<-- this is current directory")
							break
						case "cd..":
							if(commandwindowdirectorydiv.innerHTML != "root"){
								var CurrentDirectoryArray = CurrentDirectory.split("\\")
								CurrentDirectory = CurrentDirectory.replace("\\" + CurrentDirectoryArray[CurrentDirectoryArray.length -1], "")
								commandwindowdirectorydiv.innerHTML = CurrentDirectory.replace(RootReplaceKey, "root")
							}
							break
						case "cd\\":
							CurrentDirectory = RootReplaceKey
							commandwindowdirectorydiv.innerHTML = CurrentDirectory.replace(RootReplaceKey, "root")
							break
						case "\/new":
							socket.emit("CreateObject", {'deck':CurrentDirectory, "type":"newdeck"})
							socket.emit("CommandWindowUpdate", {"UpdateString":"Has created a deck with ID=", "type":"function", "user":CurrentUser})
							break
						case "\/one":
							socket.emit("CreateObject", {'src':CurrentDirectory + "\\" + cmdline.value.replace("/\one ", ""), "type":"newcard"})
							break
						case "\/roll":
							var rollkey = SwitchedCommandLineInput[1]
							var rollkeyarray = rollkey.split("x")
							var NumberRollPassString = ""
							if(rollkeyarray.length == 2){
								if(Number(rollkeyarray[0]) > 0 && Number(rollkeyarray[0]) < 100 && Number(rollkeyarray[1]) > 0 && Number(rollkeyarray[1]) < 10000){
									NumberRollPassString = NumberRollPassString + "Rolling ("+rollkeyarray[0]+"x"+rollkeyarray[1]+"): "
									for(var i = 0; i < rollkeyarray[0]; ++i){
										NumberRollPassString = NumberRollPassString + Math.floor((Math.random()*Number(rollkeyarray[1]))+1)  + ","
									}
									NumberRollPassString = NumberRollPassString.substring(0, NumberRollPassString.length - 1)
									console.log(NumberRollPassString + "<-- this is the numbers pass string")
								}
							}
							if(rollkeyarray.length == 1){
								if(Number(rollkeyarray[0]) > 0 && Number(rollkeyarray[0]) < 10000){
								NumberRollPassString = NumberRollPassString + "Rolling (1x"+rollkeyarray[0]+"): "
								NumberRollPassString = NumberRollPassString + Math.floor((Math.random()*Number(rollkeyarray[0]))+1)
								console.log(NumberRollPassString + "<-- this is the numbers pass string")
								}
							}
							if(NumberRollPassString != ""){
								socket.emit("CommandWindowUpdate", {"UpdateString":NumberRollPassString, "type":"function", "user":CurrentUser})
							}
							//socket.emit
							break
						case "\/view":
								var NewWindow = window.open("", "ViewDirectory", "height=200,width=200")
								NewWindow.document.write("<html><head><title></title></head><body></body>");

								var CardsAndDeckArray = (LocalDirectoryStructureObject[CurrentDirectory]).split(";")
								if(CardsAndDeckArray[1].length > 0){
									var CardsOnly = CardsAndDeckArray[1]
									var CardsOnlySplit = CardsOnly.split(",")
									var ReplacePathFowardSlash = CurrentDirectory.replace(/\\/g, "/")
									ReplacePathFowardSlash  = ReplacePathFowardSlash.replace("C:/AANode/", "")
									for(var k = 1; k < CardsOnlySplit.length; ++k){
										var containerdiv = document.createElement("div");
										var namestringdiv = document.createElement("div");
										var imageobjectdiv = document.createElement("div");
										var ViewDivText = document.createTextNode(String.fromCharCode(13) + String.fromCharCode(13)+ String.fromCharCode(13) + CardsOnlySplit[k])
										namestringdiv.appendChild(ViewDivText)
										//imagedividerdiv.setAttribute("style", "width:500px,height:300px")

										var image = new Image();
										console.log(ReplacePathFowardSlash + "/" + CardsOnlySplit[k] + "<-- this is the image source")
										image.src = ReplacePathFowardSlash + "/" + CardsOnlySplit[k];
										imageobjectdiv.appendChild(image)
										if(k != 1){
											containerdiv.appendChild(document.createElement("br"));
											containerdiv.appendChild(document.createElement("br"));
										}
										containerdiv.appendChild(namestringdiv)
										containerdiv.appendChild(imageobjectdiv)
										NewWindow.document.body.appendChild(containerdiv)
									}
								}
							break
						case "\/clear":
							socket.emit("Clear")
							break
						case "\/login":
							socket.emit("login", {"name":SwitchedCommandLineInput[1], "oldname":CurrentUser})
							break
						default:
							socket.emit("CommandWindowUpdate", {"UpdateString":cmdline.value, "type":"text", "user":CurrentUser})
							/*
							var HTMLText = cmdline.value
							HTMLText = HTMLText.replace(/\r?\n/g, '<br />');
							cmdwnd.innerHTML = cmdwnd.innerHTML + "<br>" + HTMLText
							console.log(cmdline.value + "<-- this is the current innerHTML")
							ScrollToEndOfChatBox()
							*/
							break
					}
				}
				cmdline.value = ""
			}
			break
			case 9:
				e.preventDefault()
				//if(e.shiftKey){
				//console.log("This is shift enter, it will go to the next line instead of submitting the shit")
				//}else{
				var cmdline = document.getElementById("commandline");
				if(cmdline.value != ""){

					var CDSingleSpaceFlag = 0
					var SwitchedCommandLineInput = ""
					var ReplaceWhiteSpace = (cmdline.value).toString()
					ReplaceWhiteSpace = ReplaceWhiteSpace.replace(/^\s+|\s+$/g,'')
					if((cmdline.value).length > ReplaceWhiteSpace.length && (ReplaceWhiteSpace.indexOf("cd") != -1 || ReplaceWhiteSpace.indexOf("\/one") != -1)){
						SwitchedCommandLineInput  = ReplaceWhiteSpace.split(" ")
						SwitchedCommandLineInput.push(" ")
					}else{
						console.log("omfg help, this is so annoying")
						SwitchedCommandLineInput = (cmdline.value).split(" ")
					}

					console.log(SwitchedCommandLineInput[0] + "<-- this is switched command input for 0")
					console.log(SwitchedCommandLineInput[1] + "<-- this is switched command input for 1")
					console.log(SwitchedCommandLineInput + "<-- this is switched command input")

					if(SwitchedCommandLineInput[0] == "cd" || SwitchedCommandLineInput[0] == "\/one"){

						DirectoryString = ""
						SearchString = ""

						if(SwitchedCommandLineInput[1].lastIndexOf("\\") == -1 && SwitchedCommandLineInput[1].length == 0){
							DirectoryString = CurrentDirectory
							SearchString = ""
						}

						if(SwitchedCommandLineInput[1].lastIndexOf("\\") == -1 && SwitchedCommandLineInput[1].length != 0){
							DirectoryString = CurrentDirectory
							SearchString = SwitchedCommandLineInput[1]
						}

						if(SwitchedCommandLineInput[1].lastIndexOf("\\") != -1 && SwitchedCommandLineInput[1].length == (SwitchedCommandLineInput[1].lastIndexOf("\\")+1)){
							console.log(SwitchedCommandLineInput[1].length + "<-- length! THIS IS THE EQUAL CASE MOFO!")
							console.log(SwitchedCommandLineInput[1].lastIndexOf("\\") + "<-- Last index of slashes!!")
							DirectoryString = CurrentDirectory + "\\" + SwitchedCommandLineInput[1].substring(0, SwitchedCommandLineInput[1].lastIndexOf("\\"))
							SearchString = ""
						}

						if(SwitchedCommandLineInput[1].lastIndexOf("\\") != -1 && SwitchedCommandLineInput[1].length != (SwitchedCommandLineInput[1].lastIndexOf("\\")+1)){
							console.log(SwitchedCommandLineInput[1].length + "<-- length!")
							console.log(SwitchedCommandLineInput[1].lastIndexOf("\\") + "<-- Last index of slashes!!")
							DirectoryString = CurrentDirectory + "\\" + SwitchedCommandLineInput[1].substring(0, SwitchedCommandLineInput[1].lastIndexOf("\\"))
							SearchString = SwitchedCommandLineInput[1].substring(SwitchedCommandLineInput[1].lastIndexOf("\\")+1, SwitchedCommandLineInput[1].length)
						}

						console.log(DirectoryString + "<-- this is the directory string")
						console.log(SearchString + "<-- this is the search string")
						if(DirectoryString in LocalDirectoryStructureObject){
							console.log("We have found directory string in local object right?")
							if(SwitchedCommandLineInput[0] == "cd"){
								LocalFilesAndDirs = LocalDirectoryStructureObject[DirectoryString].split(";")
								console.log(LocalDirectoryStructureObject[DirectoryString] + "<-- local directory string and shit?")
								if(LocalFilesAndDirs[0].length != 0){
									console.log("Local fiels and dirs is not zero or something")
									LocalFolderSplit = LocalFilesAndDirs[0].split(",")
									var WrapFlag = 1
									for(var i = 0; i < LocalFolderSplit.length; ++i){
										console.log("Hitting the inner I loop with i=" + i)
										if(LocalFolderSplit[i].toLowerCase() > SearchString.toLowerCase()){
											cmdline.value = "cd "+ (DirectoryString + "\\" + LocalFolderSplit[i]).replace(CurrentDirectory + "\\", "")
											//cmdline.value = cmdline.value + LocalFolderSplit[i]
											WrapFlag = 0
											break
										}
									}
									if(WrapFlag == 1){
										cmdline.value = "cd "+ (DirectoryString + "\\" + LocalFolderSplit[0]).replace(CurrentDirectory + "\\", "")
									}
								}
								console.log(LocalFilesAndDirs)
							}
							if(SwitchedCommandLineInput[0] == "\/one"){
								LocalFilesAndDirs = LocalDirectoryStructureObject[DirectoryString].split(";")
								console.log(LocalDirectoryStructureObject[DirectoryString] + "<-- local directory string and shit?")
								if(LocalFilesAndDirs[1].length != 0){
									console.log("Local fiels and dirs is not zero or something")
									LocalFilesSplit = LocalFilesAndDirs[1].split(",")
									var WrapFlag = 1
									for(var i = 0; i < LocalFilesSplit.length; ++i){
										console.log("Hitting the inner I loop with i=" + i)
										if(LocalFilesSplit[i].toLowerCase() > SearchString.toLowerCase()){
											cmdline.value ="\/one " + (DirectoryString + "\\" + LocalFilesSplit[i]).replace(CurrentDirectory + "\\", "")
											//cmdline.value = cmdline.value + LocalFolderSplit[i]
											WrapFlag = 0
											break
										}
									}
									if(WrapFlag == 1){
										cmdline.value = "\/one " + (DirectoryString + "\\" + LocalFolderSplit[0]).replace(CurrentDirectory + "\\", "")
									}
								}
								console.log(LocalFilesAndDirs)
							}
						}

					}
				}
				break

		}

	})

	window.onbeforeunload = function ()
	{
		//socket.emit("LeaveRoom")
		socket.emit("logout", {"name":CurrentUser})
		HandWindow.close()
	}

	socket.on("CommandWindowUpdate", function(data){
		var HTMLText = ""
		console.log("WHAT THE FUCK WHY ARENT WE ")
		//we should have a color scheme for the command window that differentiates text and commands
		console.log(data.UpdateString +"<-- this is the update string...")
		if(data.type == "text"){
			HTMLText = data.UpdateString
		}

		if(data.type == "function"){
			HTMLText = data.UpdateString
		}

		HTMLText = HTMLText.replace(/\r?\n/g, '<br />');
		cmdwnd.innerHTML = cmdwnd.innerHTML + "<br>" + HTMLText
		ScrollToEndOfChatBox()
	})

	socket.on("DirectoryStructure", function(data){
		console.log("Does this ever get to the directory structure??!??")
		LocalDirectoryStructureObject = data.DirectoryStructure
		//jQuery.extend(LocalDirectoryStructureObject, data.DirectoryStructure)
		//LocalDirectoryStructureObject = data.DirectoryStructure
		//console.log(data.DirectoryStructure)
		console.log(LocalDirectoryStructureObject)
	})

	socket.on("login", function(data){
		console.log("This has gotten to the login stage...")
		CurrentUser = data.name
	})

})




	/*
	var user = prompt("Enter your name, or don't")
	while(1)
	{
		if(user == null)
		{
			user = prompt("Enter your name, or don't")
		}
		else
		{
			break
		}
	}
*/

function ScrollToEndOfChatBox(){
	var cmdwndcontainer = document.getElementById("commandwindowcontainer");
	var scrollHeight = Math.max(cmdwndcontainer.scrollHeight, cmdwndcontainer.clientHeight);
	cmdwndcontainer.scrollTop = scrollHeight - cmdwndcontainer.clientHeight;
}


function ResizeWindow()
{
	""
	//alert("This has resized")
	console.log("The fuck is going on here?");
	console.log($(window).height() + "<-- this is the window height");
	console.log($(window).width() + "<-- this is the window width");
	cmdwnd.style.width = $(window).width() - 100;
	cmdwnd.style.height = $(window).height() - 100;

	var cmdline = document.getElementById("commandline");
	cmdline.style.width = $(window).width() - 100;

	var directorydiv = document.getElementById("currentdirectory");
	directorydiv.style.width = $(window).width() - 100;

	var cmdwndcontainer = document.getElementById("commandwindowcontainer");
	cmdwndcontainer.style.width = $(window).width() - 100;
	cmdwndcontainer.style.height = $(window).height() - 100;

	ScrollToEndOfChatBox()
}

</script>
</head>

<body onresize="ResizeWindow()">
<div id=commandwindowcontainer>
<div id=commandwindow></div>
</div>
<div id=currentdirectory></div>
<textarea id=commandline></textarea>

</body>
</html>