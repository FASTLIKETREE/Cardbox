<html>
<head>
    <meta charset="utf-8"/>
    <title>Demo</title>
	<style type="text/css">
	<link rel="stylesheet" href="Cardbox.css">
</style>

<script src="/socket.io/lib/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js"></script>


<script>
	socket = io.connect();
	socket.emit("MainWindowCreated")

	var CurrentUser = ""
	var HandWindow = 0
	var BoundDeckObject = 0
	var ActiveObject = 0
	var DecksAndCards = {}

function DCobject(){
	var self = this
	this.id = null
	this.isdeck = null
	this.imgsrc = null
	this.quantity = null

	var counterdiv = null
	var iddiv = null
	var imageobject = new Image();

	var mouseenter = {
		handleEvent: function(){
		ActiveObject = self;
		imageobject.style.border='2px solid #0000FF';
		console.log("Have entered " + self.id)
		}
	}

	var mouseenterbound = {
		handleEvent: function(){
		ActiveObject = self;
		console.log("Have entered " + self.id)
		}
	}

	var mouseleave = {
		handleEvent: function(){
		imageobject.style.border=""
		}
	}

	this.setborder = function(colorcode)
	{
		imageobject.style.border=colorcode;
	}

	this.removeMouseListeners = function(){
		imageobject.removeEventListener("mouseenter", mouseenter)
		imageobject.removeEventListener("mouseleave", mouseleave)
		imageobject.addEventListener("mouseenter", mouseenterbound, false)
	}

	this.addMouseListeners = function(){
		imageobject.addEventListener("mouseenter", mouseenter, false)
		imageobject.addEventListener("mouseleave", mouseleave, false)
		imageobject.removeEventListener("mouseleave", mouseenterbound)
	}

	this.render = function(namestring, x, y, ID, quantity, facedown)
	{
		if(this.isdeck == 0 && facedown != 1)
		{
			console.log("This is in the face up card section, is it not working?")
			this.imgsrc = namestring
			imageobject.src = namestring
			imageobject.style.position="absolute"
			imageobject.style.left = x
			imageobject.style.top = y
			imageobject.setAttribute("class", "drag")
			imageobject.addEventListener("mouseenter", mouseenter, false)
			imageobject.addEventListener("mouseleave", mouseleave, false)
			document.body.appendChild(imageobject)
		}

		if(this.isdeck == 0 && facedown == 1)
		{
			console.log("This is in the face down section, is it not working?")
			this.imgsrc = namestring
			imageobject.src = "pictures/AnotherGroupOfCards/Deck.png"
			imageobject.style.position="absolute"
			console.log("X location = " + x)
			console.log("Y location = " + y)
			imageobject.style.left = x
			imageobject.style.top = y
			imageobject.setAttribute("class", "drag")
			imageobject.addEventListener("mouseenter", mouseenter, false)
			imageobject.addEventListener("mouseleave", mouseleave, false)
			document.body.appendChild(imageobject)
		}

		if(this.isdeck == 1)
		{
			this.imgsrc = "pictures/AnotherGroupOfCards/Deck.png"
			imageobject.src = "pictures/AnotherGroupOfCards/Deck.png"
			imageobject.style.position="absolute"
			console.log("X location = " + x)
			console.log("Y location = " + y)
			imageobject.style.left = x
			imageobject.style.top = y
			imageobject.setAttribute("class", "drag")
			imageobject.addEventListener("mouseenter", mouseenter, false)
			imageobject.addEventListener("mouseleave", mouseleave, false)
			//socket.emit("CreateDeck", {'deck':namestring})
			document.body.appendChild(imageobject)
		}

			console.log("This is the quantity ->" + quantity)
			if(quantity == null){
				quantity = ""
			}
			counterdiv = document.createElement("div");
			counterdiv.style.position="absolute"
			counterdiv.style.left = x
			counterdiv.style.top = (Number(y.replace("px", "") - 30 )) + "px"
			var CounterDivText = document.createTextNode(quantity.toString())
			counterdiv.appendChild(CounterDivText)
			document.body.appendChild(counterdiv);

			iddiv = document.createElement("div");
			iddiv.style.position="absolute"
			iddiv.style.left = x
			console.log("This is the image iD that we are appending? -> " + ID)
			iddiv.style.top = (Number(y.replace("px", "") - 15 )) + "px"
			var IDDivText = document.createTextNode("ID:" + ID)
			iddiv.appendChild(IDDivText)
			document.body.appendChild(iddiv);
	}

	this.setposition = function(posx, posy)
	{
		imageobject.style.left = posx
		imageobject.style.top = posy
		console.log(counterdiv.innerHTML + "<-- this is the inner html of the counter div thing when dragging!")
		counterdiv.style.left = posx
		counterdiv.style.top = (Number(posy.replace("px", "") - 30 )) + "px"
		iddiv.style.left = posx
		iddiv.style.top = (Number(posy.replace("px", "") - 15 )) + "px"
	}

	this.updatecounterdiv = function(Quantity)
	{
		console.log(Quantity + "<- this is quantity!")
		var CurrentValue = counterdiv.innerHTML
		CurrentValue = Number(CurrentValue) + Number(Quantity)
		if(CurrentValue == 0){
			CurrentValue = ""
		}
		counterdiv.innerHTML = CurrentValue
		this.quantity = CurrentValue
	}

	this.delete = function()
	{
		delete DecksAndCards[this.id]
		imageobject.parentNode.removeChild(imageobject)
		counterdiv.parentNode.removeChild(counterdiv)
		iddiv.parentNode.removeChild(iddiv)
		ActiveObject = 0
		console.log("Does this get here and remove the shit?")
		if(this.isdeck == 1){
		console.log("Does this get here and remove the shit? in the isdeck thing?")
			socket.emit("DeleteDeck", {"DeckID":this.id})
			BoundDeckObject = 0
		}
	}

	this.flipup = function()
	{
		imageobject.src = this.imgsrc
	}

	this.flipdown = function()
	{
		imageobject.src = "pictures/AnotherGroupOfCards/Deck.png"
	}

	this.shuffle = function()
	{
		socket.emit("ShuffleDeck", {"DeckID":this.id})
	}
}


window.onbeforeunload = function ()
{
	//socket.emit("LeaveRoom")
	HandWindow.close()
}


$(document).ready(function(){
	HandWindow = window.open("createhand", "Hand", "height=200,width=600")
	CommandWindow = window.open("commandwindow", "CommandWindow", "height=400,width=1200")

	document.addEventListener("keydown", function(e)
	{
		console.log(e.keyCode +"<-- this is the keycode")
		switch(e.keyCode)
		{

			case 8: //Keycode 8 = backspace key (Delete card (not deck))
				e.preventDefault()
				if(ActiveObject != 0 && ActiveObject.isdeck == 0){
					socket.emit("DeleteObject", {"ObjectID":ActiveObject.id})
				}
				break
			case 107: //Keycode 107 = Right hand +
				if(ActiveObject != 0 && !e.altKey && !e.shiftKey){
					socket.emit("UpdateCounterDiv", {"ObjectID":ActiveObject.id, "Quantity":"1"})
				}
				if(ActiveObject != 0 && !e.altKey && e.shiftKey){
					socket.emit("UpdateCounterDiv", {"ObjectID":ActiveObject.id, "Quantity":"5"})
				}
				if(ActiveObject != 0 && e.altKey && !e.shiftKey){
					socket.emit("UpdateCounterDiv", {"ObjectID":ActiveObject.id, "Quantity":"20"})
				}
				if(ActiveObject != 0 && e.altKey && e.shiftKey){
					socket.emit("UpdateCounterDiv", {"ObjectID":ActiveObject.id, "Quantity":"100"})
				}
				break
			case 109: //Keycode 109 = Right hand -
				if(ActiveObject != 0 && !e.altKey && !e.shiftKey){
					socket.emit("UpdateCounterDiv", {"ObjectID":ActiveObject.id, "Quantity":"-1"})
				}
				if(ActiveObject != 0 && !e.altKey && e.shiftKey){
					socket.emit("UpdateCounterDiv", {"ObjectID":ActiveObject.id, "Quantity":"-5"})
				}
				if(ActiveObject != 0 && e.altKey && !e.shiftKey){
					socket.emit("UpdateCounterDiv", {"ObjectID":ActiveObject.id, "Quantity":"-20"})
				}
				if(ActiveObject != 0 && e.altKey && e.shiftKey){
					socket.emit("UpdateCounterDiv", {"ObjectID":ActiveObject.id, "Quantity":"-100"})
				}
				break

			case 46: //Keycode 46 = Delete Key (Delete deck)
				if(BoundDeckObject != 0){
					socket.emit("DeleteObject", {"ObjectID":BoundDeckObject.id})
				}
				break
			case 65: //Keycode 65 = A (Add to deck and shuffle)
				if(ActiveObject != 0 && ActiveObject.isdeck == 0){
					socket.emit("AddToDeck", {"ObjectSrc":ActiveObject.imgsrc, "ObjectID":ActiveObject.id, "Key":"a"})
				}
				break
			case 66: //Keycode 66 = B (bind deck) for deck object
				if(BoundDeckObject == 0 && ActiveObject.isdeck == 1){
					ActiveObject.removeMouseListeners()
					ActiveObject.setborder('2px solid #E8272C')
					BoundDeckObject = ActiveObject
					socket.emit("CurrentBoundDeckObject", {"DeckID":BoundDeckObject.id})
				}

				if(BoundDeckObject !== ActiveObject && ActiveObject.isdeck == 1){
					BoundDeckObject.addMouseListeners()
					BoundDeckObject.setborder("")
					BoundDeckObject = ActiveObject
					BoundDeckObject.setborder('2px solid #E8272C')
					BoundDeckObject.removeMouseListeners()
					socket.emit("CurrentBoundDeckObject", {"DeckID":BoundDeckObject.id})
				}
				break
			case 68: //Keycode 68 = D (draw card from bound deck to board)
				if(BoundDeckObject != 0){
					console.log(BoundDeckObject.id + "<-- this is the bound deck object ID!!!!!")
					socket.emit("CreateObject", {"type":"drawboard"})
				}
				break
			case 70: //Keycode 70 = F (Flip a card over)
				if(ActiveObject.isdeck == 0){
					console.log(BoundDeckObject.id + "<-- this is the bound deck object ID!!!!!")
					socket.emit("FlipCard", {"ObjectID":ActiveObject.id})
				}
				break
			case 71: //Keycode 71 = G (Grab the active card object and put it into your hand)
				if(ActiveObject != 0 && ActiveObject.isdeck == 0){
					console.log(ActiveObject.imgsrc + "<-- This card has been grabbed")
					console.log(ActiveObject.quantity + "<-- this is the quantity when grabbed!")
					//socket.emit("GrabCard", {"CardSRC":ActiveObject.imgsrc, "CardID":ActiveObject.id})
					socket.emit("CreateObject", {"ObjectSrc":ActiveObject.imgsrc, "ObjectID":ActiveObject.id, "quantity":ActiveObject.quantity,"type":"boardtohand"})
				}
				break
			case 72: //Keycode 72 = H (draw a card from bound deck to hand)
				if(BoundDeckObject != 0){
					console.log(BoundDeckObject.id + "<-- this is the bound deck object ID!!!!!")
					socket.emit("CreateObject", {"ObjectID":BoundDeckObject.id, "type":"drawhand"})
				}
				break
			case 77: //Keycode 77 = M (Put card on bottoM of bound deck)
				if(BoundDeckObject != 0 && ActiveObject.isdeck == 0){
					socket.emit("AddToDeck", {"ObjectSrc":ActiveObject.imgsrc, "ObjectID":ActiveObject.id, "Key":"m"})
				}
				break
			case 83: //Keycode 83 = S (shuffle bound deck)
				if(BoundDeckObject != 0){
					socket.emit("ShuffleDeck", {"ObjectID":BoundDeckObject.id})
				}
				break
			case 84: //Keycode 84 = T (add ActiveObject to top of deck)
				if(BoundDeckObject != 0 && ActiveObject.isdeck == 0){
					socket.emit("AddToDeck", {"ObjectSrc":ActiveObject.imgsrc, "ObjectID":ActiveObject.id, "Key":"t"})
				}
				break
			case 87: //Keycode 87 = W (Draw card face down to board)
				if(BoundDeckObject != 0){
					socket.emit("CreateObject", {"facedown":"1", "type":"drawboard"})
				}
				break
		}
	})


	socket.on("CreateObject", function(data){
		console.log(data.ObjectSrc + "<-- this is the card name")
		console.log(data.ObjectID + "<-- this is the card ID")
		console.log(data.x + "<-- this is the card x")
		console.log(data.y + "<-- this is the card y")
		console.log(data.quantity + "<-- this is thequantity")

		ActiveObject = new DCobject()
		ActiveObject.id = data.ObjectID
		ActiveObject.quantity = data.quantity

		if(data.type == "deck"){
			ActiveObject.isdeck = 1
		}
		else{
			ActiveObject.isdeck = 0
		}

		DecksAndCards[data.ObjectID] = ActiveObject
		ActiveObject.render(data.ObjectSrc, data.x, data.y, data.ObjectID, data.quantity, data.facedown)
	})

	socket.on("PositionDeck", function(data){

		console.log(data.DeckID + "<-- WWHHHHHHHHHHHHHHATTTTTTTTTTTT???")
		console.log(data.x)
		console.log(data.y)
		DecksAndCards[data.DeckID].setposition(data.x, data.y)
	})

	socket.on("FlipCardUp", function(data){
		console.log("Hitting flip card up!!")
		DecksAndCards[data.ObjectID].flipup()
		//data.ObjectID
	})

	socket.on("FlipCardDown", function(data){
		console.log("Hitting the flipd own")
		DecksAndCards[data.ObjectID].flipdown()
	})

	socket.on("UpdateCounterDiv", function(data){
	console.log(data.Quantity + "<-- this is quantity...")
		DecksAndCards[data.ObjectID].updatecounterdiv(data.Quantity)
	})


	socket.on("ToBoard", function(data){
		console.log(data.CardID + "<-- this is the to board data...")
		ActiveObject = new DCobject()
		ActiveObject.id = data.CardID
		ActiveObject.imgsrc = data.CardSrc
		ActiveObject.isdeck = 0
		DecksAndCards[data.CardID] = ActiveObject
		ActiveObject.render(data.CardSrc, 0, 0, data.CardID, data.quantity)
	})

	socket.on("DeleteObject", function(data){
		console.log(data.ObjectID)
		console.log(data)
		DecksAndCards[data.ObjectID].delete()
	})

	socket.on("RoomCounters", function(data){
		console.log(data)
	})

})

/***********************************************
* Drag and Drop Script: � Dynamic Drive (http://www.dynamicdrive.com)
* This notice MUST stay intact for legal use
* Visit http://www.dynamicdrive.com/ for this script and 100s more.
***********************************************/

</script>

</head>
<body class="advanced">

</form>
<script>

var dragobject={
countemit: 0, z: 0, x: 0, y: 0, offsetx : null, offsety : null, targetobj : null, dragapproved : 0, FinalX : null, FinalY : null, LastMovedID : null,
initialize:function(){
document.onmousedown=this.drag
document.onmouseup=function()
{
	this.dragapproved=0
	if(ActiveObject != 0){
	socket.emit("PositionDeck", {"DeckID": LastMovedID, "x":FinalX, "y":FinalY})}
}
},
drag:function(e){

var evtobj=window.event? window.event : e
this.targetobj=window.event? event.srcElement : e.target

var evtobj=window.event || e
this.targetobj=event.srcElement || e.target
if (this.targetobj.className=="drag"){
this.dragapproved=1
this.countemit = 0
if (isNaN(parseInt(this.targetobj.style.left))){this.targetobj.style.left=0}
if (isNaN(parseInt(this.targetobj.style.top))){this.targetobj.style.top=0}


//This sets the left and top of the image, where it is loaded on the page
this.offsetx=parseInt(this.targetobj.style.left)
console.log(this.offsetx + "<-- this is the offset x")
this.offsety=parseInt(this.targetobj.style.top)
console.log(this.offsety + "<-- this is the offset y")


//The event object which is passed automatically to a function when bound to an event, like onmousedown
// has x and y coordinantes of e.clientX and e.clientY, in this case e is evtobj which is a selection between the window.event, and the automatically passed variable, this is
//a difference between IE and other browsers

this.x=evtobj.clientX
console.log(this.x + "<-- this is the clientx")
this.y=evtobj.clientY
console.log(this.y + "<-- this is the clienty\n")

//FinalX = this.offsetx+evtobj.clientX-this.x+"px"
//FinalY = this.offsety+evtobj.clientY-this.y+"px"

if (evtobj.preventDefault)
evtobj.preventDefault()

document.onmousemove=dragobject.moveit
}
},
moveit:function(e){
var evtobj=window.event? window.event : e
if (this.dragapproved==1){
this.targetobj.style.left=this.offsetx+evtobj.clientX-this.x+"px"
this.targetobj.style.top=this.offsety+evtobj.clientY-this.y+"px"

this.countemit = this.countemit + 1
FinalX = this.offsetx+evtobj.clientX-this.x+"px"
FinalY = this.offsety+evtobj.clientY-this.y+"px"
LastMovedID = ActiveObject.id

if (this.countemit == 10)
{
	console.log(ActiveObject.id + "<-- this is the longDesc, and should be the ID of the deck object")
	this.countemit = 0
	if(ActiveObject != 0){
	console.log("Never get to here or what?")
	socket.emit("PositionDeck", {"DeckID": ActiveObject.id, "x":this.offsetx+evtobj.clientX-this.x+"px", "y":this.targetobj.style.top=this.offsety+evtobj.clientY-this.y+"px"})}
}

return false
}
}
}
//deckobject.initialize()
dragobject.initialize()


</script>

</body>
</html>