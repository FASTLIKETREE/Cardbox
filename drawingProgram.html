<html>
<head>
    <meta charset="utf-8"/>
    <title>Demo</title>
	<style type="text/css">
	<link rel="stylesheet" href="Cardbox.css">
</style>

<script src="/socket.io/lib/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js"></script>


<script>
	socket = io.connect();
	socket.emit("MainWindowCreated")

	var HandWindow = 0
	var BoundDeckObject = 0
	var ActiveObject = 0
	var DecksAndCards = {}

function DCobject(){
	var self = this
	this.id = null
	this.isdeck = null
	this.imgsrc = null

	var imageobject = new Image();

	var mouseenter = {
		handleEvent: function(){
		ActiveObject = self;
		imageobject.style.border='2px solid #0000FF';
		console.log("Have entered " + self.id)
		}
	}

	var mouseenterbound = {
		handleEvent: function(){
		ActiveObject = self;
		console.log("Have entered " + self.id)
		}
	}

	var mouseleave = {
		handleEvent: function(){
		imageobject.style.border=""
		}
	}

	this.setborder = function(colorcode)
	{
		imageobject.style.border=colorcode;
	}

	this.removeMouseListeners = function(){
		imageobject.removeEventListener("mouseenter", mouseenter)
		imageobject.removeEventListener("mouseleave", mouseleave)
		imageobject.addEventListener("mouseenter", mouseenterbound, false)
	}

	this.addMouseListeners = function(){
		imageobject.addEventListener("mouseenter", mouseenter, false)
		imageobject.addEventListener("mouseleave", mouseleave, false)
		imageobject.removeEventListener("mouseleave", mouseenterbound)
	}

	this.render = function(namestring, x, y)
	{
		if(this.isdeck == 0)
		{
			this.imgsrc = namestring
			imageobject.src = namestring
			imageobject.style.position="absolute"
			imageobject.style.left = x
			imageobject.style.top = y
			imageobject.setAttribute("class", "drag")
			imageobject.addEventListener("mouseenter", mouseenter, false)
			imageobject.addEventListener("mouseleave", mouseleave, false)
			document.body.appendChild(imageobject)
		}
		if(this.isdeck == 1)
		{
			this.imgsrc = "pictures/AnotherGroupOfCards/Deck.png"
			imageobject.src = "pictures/AnotherGroupOfCards/Deck.png"
			imageobject.style.position="absolute"
			console.log("X location = " + x)
			console.log("Y location = " + y)
			imageobject.style.left = x
			imageobject.style.top = y
			imageobject.setAttribute("class", "drag")
			imageobject.addEventListener("mouseenter", mouseenter, false)
			imageobject.addEventListener("mouseleave", mouseleave, false)
			//socket.emit("CreateDeck", {'deck':namestring})
			document.body.appendChild(imageobject)
		}
	}

	this.setposition = function(posx, posy)
	{
		imageobject.style.left = posx
		imageobject.style.top = posy
	}

/*
	this.drawcard = function(CardName, CardID)
	{
		ActiveObject = new DCObject()
		//ActiveObject.
		ActiveObject.render(CardName)
	}
*/

	this.delete = function()
	{
		delete DecksAndCards[this.id]
		imageobject.parentNode.removeChild(imageobject)
		ActiveObject = 0
		if(this.isdeck == 1){
			socket.emit("DeleteDeck", {"DeckID":this.id})
			BoundDeckObject = 0
		}
	}

	this.shuffle = function()
	{
		socket.emit("ShuffleDeck", {"DeckID":this.id})
	}
}


window.onbeforeunload = function ()
{
	//socket.emit("LeaveRoom")
	HandWindow.close()
}


$(document).ready(function(){
	HandWindow = window.open("createhand", "Hand", "height=400,width=1200")
	CommandWindow = window.open("commandwindow", "CommandWindow", "height=400,width=1200")

	document.addEventListener("keydown", function(e)
	{
		switch(e.keyCode)
		{
			case 8: //Keycode 8 = backspace key (Delete card (not deck))
				e.preventDefault()
				if(ActiveObject != 0 && ActiveObject.isdeck == 0){
					socket.emit("DeleteObject", {"ObjectID":ActiveObject.id})
				}
				break
			case 46: //Keycode 46 = Delete Key (Delete deck)
				if(BoundDeckObject != 0){
					socket.emit("DeleteObject", {"ObjectID":BoundDeckObject.id})
				}
				break
			case 65: //Keycode 65 = A (Add to deck and shuffle)
				if(ActiveObject != 0 && ActiveObject.isdeck == 0){
					socket.emit("AddToDeck", {"ObjectSrc":ActiveObject.imgsrc, "ObjectID":ActiveObject.id, "Key":"m"})
				}
				break
			case 66: //Keycode 66 = B (bind deck) for deck object
				if(BoundDeckObject == 0 && ActiveObject.isdeck == 1){
					ActiveObject.removeMouseListeners()
					ActiveObject.setborder('2px solid #E8272C')
					BoundDeckObject = ActiveObject
					socket.emit("CurrentBoundDeckObject", {"DeckID":BoundDeckObject.id})
				}

				if(BoundDeckObject !== ActiveObject && ActiveObject.isdeck == 1){
					BoundDeckObject.addMouseListeners()
					BoundDeckObject.setborder("")
					BoundDeckObject = ActiveObject
					BoundDeckObject.setborder('2px solid #E8272C')
					BoundDeckObject.removeMouseListeners()
					socket.emit("CurrentBoundDeckObject", {"DeckID":BoundDeckObject.id})
				}
				break
			case 68: //Keycode 68 = D (draw card from bound deck to board)
				if(BoundDeckObject != 0){
					console.log(BoundDeckObject.id + "<-- this is the bound deck object ID!!!!!")
					socket.emit("CreateObject", {"type":"drawboard"})
				}
				break
			case 71: //Keycode 71 = G (Grab the active card object and put it into your hand)
				if(ActiveObject != 0 && ActiveObject.isdeck == 0){
					console.log(ActiveObject.imgsrc + "<-- This card has been grabbed")
					//socket.emit("GrabCard", {"CardSRC":ActiveObject.imgsrc, "CardID":ActiveObject.id})
					socket.emit("CreateObject", {"ObjectSrc":ActiveObject.imgsrc, "ObjectID":ActiveObject.id, "type":"boardtohand"})
				}
				break
			case 72: //Keycode 72 = H (draw a card from bound deck to hand)
				if(BoundDeckObject != 0){
					console.log(BoundDeckObject.id + "<-- this is the bound deck object ID!!!!!")
					socket.emit("CreateObject", {"ObjectID":BoundDeckObject.id, "type":"drawhand"})
				}
				break
			case 77: //Keycode 77 = M (Put card on bottoM of bound deck)
				if(BoundDeckObject != 0 && ActiveObject.isdeck == 0){
					socket.emit("AddToDeck", {"ObjectSrc":ActiveObject.imgsrc, "ObjectID":ActiveObject.id, "Key":"m"})
				}
				break
			case 83: //Keycode 83 = S (shuffle bound deck)
				if(BoundDeckObject != 0){
					socket.emit("ShuffleDeck", {"DeckID":BoundDeckObject.id})
				}
				break
			case 84: //Keycode 84 = T (add ActiveObject to top of deck)
				if(BoundDeckObject != 0 && ActiveObject.isdeck == 0){
					socket.emit("AddToDeck", {"ObjectSrc":ActiveObject.imgsrc, "ObjectID":ActiveObject.id, "Key":"t"})
				}
				break
		}
	})


	socket.on("CreateObject", function(data){
		console.log(data.ObjectSrc + "<-- this is the card name")
		console.log(data.ObjectID + "<-- this is the card ID")
		console.log(data.x + "<-- this is the card x")
		console.log(data.y + "<-- this is the card y")

		ActiveObject = new DCobject()
		ActiveObject.id = data.ObjectID

		if(data.type == "deck"){
			ActiveObject.isdeck = 1
		}
		else{
			ActiveObject.isdeck = 0
		}

		DecksAndCards[data.ObjectID] = ActiveObject
		ActiveObject.render(data.ObjectSrc, data.x, data.y)
	})

	socket.on("PositionDeck", function(data){
		console.log(data.DeckID)
		console.log(data.x)
		console.log(data.y)
		DecksAndCards[data.DeckID].setposition(data.x, data.y)
	})

	socket.on("ToBoard", function(data){
		console.log(data.CardID + "<-- this is the to board data...")
		ActiveObject = new DCobject()
		ActiveObject.id = data.CardID
		ActiveObject.imgsrc = data.CardSrc
		ActiveObject.isdeck = 0
		DecksAndCards[data.CardID] = ActiveObject
		ActiveObject.render(data.CardSrc)
	})

	socket.on("DeleteObject", function(data){
		console.log(data.ObjectID)
		console.log(data)
		DecksAndCards[data.ObjectID].delete()
	})

	socket.on("RoomCounters", function(data){
		console.log(data)
	})

	socket.on("CreateStandardGameElements")

	socket.on('DecksDir', function(data){
		data = data.slice(0, data.length -1)
		var DecksArray = data.split(";")
		console.log("Decks dir!")
		//console.log(DecksArray.join())
		for(var i = 0; i < DecksArray.length; i=i+1)
		{
			var DeckArray = DecksArray[i].split(",")
			//console.log(DeckArray.join())
			DeckArray.splice(1,1)
			//console.log(DeckArray.join())

			var cardsButtonView = document.createElement("button");
			cardsButtonView.style.position="absolute"
			cardsButtonView.style.left = "0px"
			cardsButtonView.style.top = i*25 + "px"
			//DistanceYViewButton = DistanceYViewButton + 6

			var cardsButtonCreate = document.createElement("button");
			cardsButtonCreate.style.position="absolute"
			cardsButtonCreate.style.left = "200px"
			cardsButtonCreate.style.top = i*25 + "px"

			//console.log(data + "<-- this is the split array")
			//console.log(data.length + "<-- this is the length")

			var buttonTextView = document.createTextNode("View_" + DeckArray[0])
			var buttonTextCreate = document.createTextNode("Create_" + DeckArray[0])
			cardsButtonView.appendChild(buttonTextView)
			cardsButtonCreate.appendChild(buttonTextCreate)

			cardsButtonCreate.onclick=(function(namestring)
			{
				return function()
				{
					socket.emit("CreateObject", {'deck':namestring, "type":"newdeck"})
					//ActiveObject = new deckobject()
					//ActiveObject.createdeck(namestring)
				}
			})(DeckArray[0])


			cardsButtonView.onclick = (function(namestring){
				return function(){
				//console.log("This should emit something to the socket, i don't see it")
				//console.log(namestring + "<-- this is data i")
				var NewWindow = window.open("", "MsgWindow", "height=200,width=200")
				NewWindow.document.write("<html><head><title></title></head><body></body>");
				CardsAndDeckArray = namestring.split(",")

					for(var k = 1; k < CardsAndDeckArray.length; ++k)
					{
						var image = new Image();
						//console.log("pictures/" + CardsAndDeckArray[0] + "/" + CardsAndDeckArray[k] + "<-- this is the image source")
						image.src = "pictures/" + CardsAndDeckArray[0] + "/" + CardsAndDeckArray[k];
						NewWindow.document.body.appendChild(image)
					}
				}
			})(DeckArray.join())

			document.body.appendChild(cardsButtonView);
			document.body.appendChild(cardsButtonCreate);

		}
	})

	socket.emit("PopulateDecks")
})

/***********************************************
* Drag and Drop Script: ï¿½ Dynamic Drive (http://www.dynamicdrive.com)
* This notice MUST stay intact for legal use
* Visit http://www.dynamicdrive.com/ for this script and 100s more.
***********************************************/

</script>

</head>
<body class="advanced">

<div id=CounterX> some serious x </div>
<div id=CounterY> some serious x </div>
</form>
<script>

var dragobject={
countemit: 0, z: 0, x: 0, y: 0, offsetx : null, offsety : null, targetobj : null, dragapproved : 0, FinalX : null, FinalY : null,
initialize:function(){
document.onmousedown=this.drag
document.onmouseup=function()
{
	this.dragapproved=0
	if(ActiveObject != 0){
	socket.emit("PositionDeck", {"DeckID": ActiveObject.id, "x":FinalX, "y":FinalY})}
}
},
drag:function(e){

var evtobj=window.event? window.event : e
this.targetobj=window.event? event.srcElement : e.target

var evtobj=window.event || e
this.targetobj=event.srcElement || e.target
if (this.targetobj.className=="drag"){
this.dragapproved=1
this.countemit = 0
if (isNaN(parseInt(this.targetobj.style.left))){this.targetobj.style.left=0}
if (isNaN(parseInt(this.targetobj.style.top))){this.targetobj.style.top=0}


//This sets the left and top of the image, where it is loaded on the page
this.offsetx=parseInt(this.targetobj.style.left)
console.log(this.offsetx + "<-- this is the offset x")
this.offsety=parseInt(this.targetobj.style.top)
console.log(this.offsety + "<-- this is the offset y")


//The event object which is passed automatically to a function when bound to an event, like onmousedown
// has x and y coordinantes of e.clientX and e.clientY, in this case e is evtobj which is a selection between the window.event, and the automatically passed variable, this is
//a difference between IE and other browsers

this.x=evtobj.clientX
console.log(this.x + "<-- this is the clientx")
this.y=evtobj.clientY
console.log(this.y + "<-- this is the clienty\n")

if (evtobj.preventDefault)
evtobj.preventDefault()

document.onmousemove=dragobject.moveit
}
},
moveit:function(e){
var evtobj=window.event? window.event : e
if (this.dragapproved==1){
this.targetobj.style.left=this.offsetx+evtobj.clientX-this.x+"px"
this.targetobj.style.top=this.offsety+evtobj.clientY-this.y+"px"
this.countemit = this.countemit + 1
FinalX = this.offsetx+evtobj.clientX-this.x+"px"
FinalY = this.offsety+evtobj.clientY-this.y+"px"

if (this.countemit == 10)
{
	console.log(ActiveObject.id + "<-- this is the longDesc, and should be the ID of the deck object")
	this.countemit = 0
	if(ActiveObject != 0){
	socket.emit("PositionDeck", {"DeckID": ActiveObject.id, "x":this.offsetx+evtobj.clientX-this.x+"px", "y":this.targetobj.style.top=this.offsety+evtobj.clientY-this.y+"px"})}
}

return false
}
}
}
//deckobject.initialize()
dragobject.initialize()


</script>

</body>
</html>